# Background Tasks

## 作业队列（已选：RQ）

- 使用 RQ 运行长耗时排课作业
- Redis 作为队列与发布/订阅进度通道
- 选择理由：依赖简单、易于私有化部署、与 Redis 集成紧密；功能满足排课作业需求
- 备选（不选 Celery）：功能更全但依赖更重，私有化复杂度更高

## 模式

- 幂等作业处理与检查点（checkpoint）
- 支持取消与回滚
- 瞬时失败的退避与重试策略

## 队列与并发

- 队列划分：`high`（管理/紧急）、`default`（普通）、`low`（批量/低优先）
- 并发：每 worker 进程 `N` 并发（按 CPU 决定）；任务亲和：优化类作业与可行性作业可以分队列
- 任务 TTL：保留最近 M 条成功/失败任务；大 payload 存至 S3/DB，仅保存引用

## 进度事件 schema（版本/兼容）

- 参考 `algorithms/feasibility-and-diagnostics.md` 的事件体；字段包括 `version`, `event`, `phase`, `percent`, `metrics`
- 兼容策略：保持向后兼容，新增字段以可选形式引入；版本号用于客户端分支处理

## 幂等与去重

- `Idempotency-Key`：对同一输入快照与参数，相同键只保留一个运行实例
- 去重：相同 `timetable_id` 且参数完全一致的排课请求在短时间窗口内合并/拒绝

## 大实例处理

- 分片/子任务：按校区/时间块拆分；父任务跟踪子任务进度与聚合结果
- 资源保护：根据规模估算 CPU/内存与时间预算，超过阈值拒绝或排入低优先队列

## 观测与告警

- 指标：队列长度、等待时间、任务执行时长、成功率、重试次数
- 告警：队列长度超阈、失败率飙升、作业超时未完成
